---
title: "Parallel Tests"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## New method 
```{r}
library(doParallel)
library(tidyverse)
library(raster)
library(sf)
gc()
raster::rasterOptions(
  maxmemory = 5e+10,
  chunksize = 1e+09
)
training_poly_path = "shapefiles/training_polygons12N_03172020_UPDATE_OTHER_VEG.shp" 
tile_shape_path = "shapefiles/SanMiguel_West.shp"
imagery_folder = "DATA/Tiffs_W_SM"
height_raster_folder = "DATA/NOC_heights/WestSM_dZgridded"

tile_list<-model_tiles(tile_shape_path, training_poly_path)
  
list_length<-length(tile_list)


n_cores<-19
cl<-makePSOCKcluster(n_cores) ##if you're on a mac, this should be makeCluster()

registerDoParallel(cl)

start_time<-Sys.time()
final_data_list<-foreach(i = 1:list_length, .combine = "rbind") %dopar% {
  
    train_data3(tile_list[i], imagery_folder, height_raster_folder, training_poly_path)
}

start_time-Sys.time()

stopCluster(cl)

```
That didn't work either. 
```{r}
source("R/load_funcs.R")
library(parallel)
gc()
rasterOptions(
  maxmemory = 5e+10,
  chunksize = 5e+09
)
training_poly_path = "shapefiles/training_polygons12N_03172020_UPDATE_OTHER_VEG.shp" 
tile_shape_path = "shapefiles/SanMiguel_West.shp"
imagery_folder = "DATA/Tiffs_W_SM"
height_raster_folder = "DATA/NOC_heights/WestSM_dZgridded"

tile_list<-model_tiles(tile_shape_path, training_poly_path)
  
list_length<-length(tile_list)
final_data_list<-vector(mode = "list", length = list_length)

n_cores<-19

start_time<-Sys.time()
final_list<- mclapply(tile_list, train_data2, imagery_folder, height_raster_folder, training_poly_path, mc.cores = n_cores)

Sys.time()-start_time
```
